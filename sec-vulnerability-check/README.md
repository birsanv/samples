# Scripts Directory

This directory contains utility scripts for the cluster-backup-operator project.

## ğŸ” Vulnerability Scanner (`vuln-check.sh`)

A comprehensive vulnerability scanning script that uses `govulncheck` to identify security issues in Go dependencies and code. The scanner now features **real-time severity fetching** from the Go vulnerability database, providing color-coded severity assessments and actionable security intelligence.

### âœ¨ Enhanced Features

- **ğŸ” [Real-time Severity Analysis](#severity-detection-method)** - Fetches actual severity levels from Go's vulnerability database
- **ğŸ¨ [Color-coded Security Badges](#severity-badge-legend)** - Visual severity indicators (ğŸŸ¢ LOW, ğŸŸ¡ MEDIUM, ğŸ”´ HIGH, ğŸ’€ CRITICAL)
- **ğŸ“Š [Comprehensive Reporting](#sample-output)** - Detailed breakdown of Standard Library vs Third-party vulnerabilities
- **ğŸš€ [Actionable Recommendations](#sample-output)** - Specific update commands for fixing vulnerabilities
- **âš¡ [Multiple Scan Modes](#scan-types)** - Module, Symbol, and Binary scanning options
- **ğŸš€ [Performance Optimized](#performance-optimizations)** - Concurrent processing with timeout protection
- **ğŸ”§ [CI/CD Integration Ready](#ci-cd-integration-ready)** - Machine-readable output for automation

### Quick Start

```bash
# Install govulncheck and run all scans
./scripts/vuln-check.sh -i && ./scripts/vuln-check.sh -a

# Quick module scan (recommended for CI)
./scripts/vuln-check.sh -m

# Detailed symbol scan with verbose output
./scripts/vuln-check.sh -s -v
```

### Available Options

| Option | Description |
|--------|-------------|
| `-h, --help` | Show help message |
| `-m, --module` | Fast scan of dependencies only |
| `-s, --symbol` | Detailed scan checking actual usage |
| `-b, --binary` | Scan compiled binary (requires build) |
| `-v, --verbose` | Show verbose output |
| `-a, --all` | Run all scan types |
| `-i, --install` | Install/update govulncheck tool |

### Scan Types

1. **Module Scan** (`-m`) - Fast dependency scan
   - Scans `go.mod` for known vulnerabilities
   - Fastest option for CI/CD pipelines
   - Shows all vulnerabilities in dependencies

2. **Symbol Scan** (`-s`) - Detailed usage analysis
   - Performs static analysis to check if vulnerable symbols are actually called
   - More precise than module scan - only reports vulnerabilities in code you use
   - Slower but eliminates false positives from unused vulnerable dependencies
   - Best for development and pre-release security validation

3. **Binary Scan** (`-b`) - Compiled binary analysis
   - Scans compiled binaries for vulnerabilities
   - Intelligently searches for binaries in common locations:
     - `./manager`, `./bin/manager`
     - `./cluster-backup-operator`, `./bin/cluster-backup-operator`
   - **Auto-build capability**: Automatically builds binary if not found
     - Tries `make build` first, then falls back to `go build -o manager .`
   - Most accurate for production deployment verification

### Integration Examples

#### GitHub Actions
```yaml
- name: Vulnerability Check
  run: ./scripts/vuln-check.sh -m
```

#### Pre-commit Hook
```bash
#!/bin/sh
./scripts/vuln-check.sh -m || exit 1
```

#### Makefile Integration
```makefile
.PHONY: vuln-check
vuln-check:
	./scripts/vuln-check.sh -m

.PHONY: vuln-check-verbose
vuln-check-verbose:
	./scripts/vuln-check.sh -a -v
```

### Sample Output

Here's an example of the enhanced vulnerability scanner output with severity information:

#### Module Scan Example (`-m`)

```bash
$ ./scripts/vuln-check.sh -m

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  Vulnerability Scanner                       â•‘
â•‘              cluster-backup-operator                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

=== Go Environment Information ===
Go Version: go version go1.23.0 darwin/arm64
GOPATH: /Users/user/go
GOROOT: /Users/user/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.23.0.darwin-arm64
Project Root: /path/to/cluster-backup-operator

[SUCCESS] Found govulncheck at: /Users/user/go/bin/govulncheck

=== Module Vulnerability Scan ===
[INFO] Scanning dependencies in go.mod for vulnerabilities...
[INFO] Fetching severity information from vulnerability database...

=== ğŸ” CVE Scan Results for cluster-backup-operator ===

**Found vulnerabilities!** Here's what I discovered:

### ğŸ“Š **Vulnerability Summary:**
- **Total CVEs Found:** 10 vulnerabilities
- **Standard Library:** 9 CVEs (from Go go1.23.0)
- **Third-party Dependencies:** 1 CVE âš ï¸

### ğŸ¥‰ **Security Assessment: NEEDS ATTENTION**
Dependencies need security updates.

### ğŸ“‹ **Detailed CVE Breakdown:**

**ğŸ”´ Standard Library CVEs (9):**
- `GO-2025-3751` [ğŸŸ¢ LOW]: Sensitive headers not cleared on cross-origin redirect in net/http
  ğŸ”§ **Fixed in**: `stdlib@go1.23.10`
- `GO-2025-3750` [ğŸŸ¢ LOW]: Inconsistent handling of O_CREATE|O_EXCL on Unix and Windows in os
  ğŸ”§ **Fixed in**: `stdlib@go1.23.10`
- `GO-2025-3563` [ğŸŸ¢ LOW]: Request smuggling due to acceptance of invalid chunked data in net/http
  ğŸ”§ **Fixed in**: `stdlib@go1.23.8`
- `GO-2025-3447` [ğŸŸ¢ LOW]: Timing sidechannel for P-256 on ppc64le in crypto/internal/nistec
  ğŸ”§ **Fixed in**: `stdlib@go1.23.6`
- `GO-2025-3420` [ğŸŸ¢ LOW]: Sensitive headers incorrectly sent after cross-domain redirect in net/http
  ğŸ”§ **Fixed in**: `stdlib@go1.23.5`
- `GO-2025-3373` [ğŸŸ¢ LOW]: Usage of IPv6 zone IDs can bypass URI name constraints in crypto/x509
  ğŸ”§ **Fixed in**: `stdlib@go1.23.5`
- `GO-2024-3107` [ğŸŸ¢ LOW]: Stack exhaustion in Parse in go/build/constraint
  ğŸ”§ **Fixed in**: `stdlib@go1.23.1`
- `GO-2024-3106` [ğŸŸ¢ LOW]: Stack exhaustion in Decoder.Decode in encoding/gob
  ğŸ”§ **Fixed in**: `stdlib@go1.23.1`
- `GO-2024-3105` [ğŸŸ¢ LOW]: Stack exhaustion in all Parse functions in go/parser
  ğŸ”§ **Fixed in**: `stdlib@go1.23.1`

**ğŸŸ¡ Third-party Dependencies (1):**
- `GO-2025-3595` [ğŸŸ¢ LOW]: Incorrect Neutralization of Input During Web Page Generation in x/net
  ğŸ“¦ **Module**: `golang.org/x/net`
  ğŸ“ **Found in**: `golang.org/x/net@v0.36.0`
  ğŸ”§ **Fixed in**: `golang.org/x/net@v0.38.0`
  ğŸ“„ **go.mod**: `golang.org/x/net@v0.36.0` â†’ update to `@latest`

### ğŸš€ **Recommended Fixes:**

1. **Update Go version:**
```bash
go install golang.org/dl/go1.23.11@latest
go1.23.11 download
go mod edit -go=1.23.11
go mod tidy
```

2. **Update vulnerable dependencies:**
```bash
go get -u golang.org/x/net@latest
```

=== Security Recommendations ===
ğŸ”„ Ongoing Security Practices:
  â€¢ Weekly scans: ./scripts/vuln-check.sh -m
  â€¢ Pre-release: ./scripts/vuln-check.sh -a -v
  â€¢ CI Integration: Add vulnerability checks to GitHub Actions

ğŸ“š Learn More:
  â€¢ Go Security: https://go.dev/security/
  â€¢ Vulnerability DB: https://pkg.go.dev/vuln/
```

#### Symbol Scan Example (`-s`)

```bash
$ ./scripts/vuln-check.sh -s

=== Symbol Vulnerability Scan ===
[INFO] Scanning for vulnerable symbols in actual code usage...
Running: govulncheck -scan=symbol .

[SUCCESS] Symbol scan completed - no vulnerable symbols found in your code!
```

#### Binary Scan Example (`-b`)

```bash
$ ./scripts/vuln-check.sh -b

=== Binary Vulnerability Scan ===
[INFO] Scanning compiled binary for vulnerabilities...
[SUCCESS] Found existing binary: ./manager
Running: govulncheck -scan=binary ./manager

[SUCCESS] Binary scan completed - no vulnerabilities found in compiled binary!
```

#### Auto-build Binary Example

```bash
$ ./scripts/vuln-check.sh -b

=== Binary Vulnerability Scan ===
[INFO] Scanning compiled binary for vulnerabilities...
[WARNING] No compiled binary found. Attempting to build...
[INFO] Building binary using make...
[SUCCESS] Binary built successfully: ./manager
Running: govulncheck -scan=binary ./manager

[SUCCESS] Binary scan completed - no vulnerabilities found in compiled binary!
```

### Severity Badge Legend

- ğŸŸ¢ **LOW** - Minor issues, can be scheduled for regular maintenance
- ğŸŸ¡ **MEDIUM** - Moderate risk, should be addressed in next release cycle  
- ğŸ”´ **HIGH** - Significant risk, requires prompt attention
- ğŸ’€ **CRITICAL** - Severe security risk, immediate action required

### Technical Details

### Severity Detection Method

The vulnerability scanner employs a multi-layered approach to determine severity:

1. **Real-time API Fetching** - Queries the Go vulnerability database at `https://pkg.go.dev/vuln/` for each CVE
2. **Intelligent Parsing** - Extracts severity information from vulnerability database responses
3. **Fallback Classification** - Uses pattern matching on vulnerability descriptions when API data is unavailable:
   - Stack exhaustion, DoS patterns â†’ `MEDIUM`
   - Code execution, overflow patterns â†’ `HIGH` 
   - Information disclosure, bypass â†’ `MEDIUM`
   - Unknown patterns â†’ `UNKNOWN`

### Performance Optimizations

- **Concurrent Processing** - Fetches severity data in parallel for faster scanning
- **Timeout Protection** - 3-second timeout per API request to prevent hanging
- **Graceful Degradation** - Continues operation even if vulnerability database is unreachable

### CI-CD-Integration-Ready

The scanner is designed for seamless CI/CD integration:
- **Machine-readable exit codes** for automated decision making
- **Structured output** suitable for parsing by other tools
- **Progress indicators** for long-running scans
- **Configurable verbosity** levels

### Exit Codes

- `0` - No vulnerabilities found (clean scan)
- `1` - Script error, tool not found, or build failures
- `3` - Vulnerabilities found (matches govulncheck standard exit code)

### Common Issues

**govulncheck not found:**
```bash
./scripts/vuln-check.sh -i  # Install the tool
```

**Internal errors:**
- Update Go to latest patch version
- Clear module cache: `go clean -modcache`

**Binary not found (for `-b` binary scan):**
- Script automatically attempts to build binary using:
  1. `make build` (if Makefile exists)
  2. `go build -o manager .` (fallback)
- Searches these locations: `./manager`, `./bin/manager`, `./cluster-backup-operator`, `./bin/cluster-backup-operator`
- If build fails, ensure dependencies are available: `go mod tidy`

### Security Workflow

1. **Daily/Weekly**: `./scripts/vuln-check.sh -m`
2. **Pre-release**: `./scripts/vuln-check.sh -a -v`
3. **After Go updates**: `./scripts/vuln-check.sh -s`
4. **CI Pipeline**: `./scripts/vuln-check.sh -m`

### Related Links

- [govulncheck documentation](https://pkg.go.dev/golang.org/x/vuln/cmd/govulncheck)
- [Go vulnerability database](https://pkg.go.dev/vuln/)
- [Security advisories](https://github.com/golang/vulndb) 