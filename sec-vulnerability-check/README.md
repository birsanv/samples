# Scripts Directory

This directory contains utility scripts for the cluster-backup-operator project.

## 🔍 Vulnerability Scanner (`vuln-check.sh`)

A comprehensive vulnerability scanning script that uses `govulncheck` to identify security issues in Go dependencies and code. The scanner now features **real-time severity fetching** from the Go vulnerability database, providing color-coded severity assessments and actionable security intelligence.

### ✨  Features
- **🔍 Real-time Severity Analysis** - Fetches actual severity levels from Go's vulnerability database
- **🎨 Color-coded Security Badges** - Visual severity indicators (🟢 LOW, 🟡 MEDIUM, 🔴 HIGH, 💀 CRITICAL)
- **📊 Comprehensive Reporting** - Detailed breakdown of Standard Library vs Third-party vulnerabilities
- **🚀 Actionable Recommendations** - Specific update commands for fixing vulnerabilities



### Quick Start

```bash
# Install govulncheck and run all scans
./scripts/vuln-check.sh -i && ./scripts/vuln-check.sh -a

# Quick module scan (recommended for CI)
./scripts/vuln-check.sh -m

# Detailed symbol scan with verbose output
./scripts/vuln-check.sh -s -v
```

### Available Options

| Option | Description |
|--------|-------------|
| `-h, --help` | Show help message |
| `-m, --module` | Fast scan of dependencies only |
| `-s, --symbol` | Detailed scan checking actual usage |
| `-b, --binary` | Scan compiled binary (requires build) |
| `-v, --verbose` | Show verbose output |
| `-a, --all` | Run all scan types |
| `-i, --install` | Install/update govulncheck tool |

### Scan Types

1. **Module Scan** (`-m`) - Fast dependency scan
   - Scans `go.mod` for known vulnerabilities
   - Fastest option for CI/CD pipelines
   - Shows all vulnerabilities in dependencies

2. **Symbol Scan** (`-s`) - Detailed usage analysis
   - Checks if vulnerable code is actually called
   - More accurate but slower
   - Best for development and pre-release checks

3. **Binary Scan** (`-b`) - Compiled binary analysis
   - Scans the built `bin/manager` binary
   - Most accurate for production deployments
   - Automatically builds binary if needed

### Integration Examples

#### GitHub Actions
```yaml
- name: Vulnerability Check
  run: ./scripts/vuln-check.sh -m
```

#### Pre-commit Hook
```bash
#!/bin/sh
./scripts/vuln-check.sh -m || exit 1
```

#### Makefile Integration
```makefile
.PHONY: vuln-check
vuln-check:
   ./scripts/vuln-check.sh -m

.PHONY: vuln-check-verbose
vuln-check-verbose:
   ./scripts/vuln-check.sh -a -v
```

### Sample Output

Here's an example of the enhanced vulnerability scanner output with severity information:

```bash
$ ./scripts/vuln-check.sh -m

╔══════════════════════════════════════════════════════════════╗
║                  Vulnerability Scanner                       ║
║              cluster-backup-operator                         ║
╚══════════════════════════════════════════════════════════════╝

=== Go Environment Information ===
Go Version: go version go1.23.0 darwin/arm64
GOPATH: /Users/user/go
GOROOT: /Users/user/go/pkg/mod/golang.org/toolchain@v0.0.1-go1.23.0.darwin-arm64
Project Root: /path/to/cluster-backup-operator

[SUCCESS] Found govulncheck at: /Users/user/go/bin/govulncheck

=== Module Vulnerability Scan ===
[INFO] Scanning dependencies in go.mod for vulnerabilities...
[INFO] Fetching severity information from vulnerability database...

=== 🔍 CVE Scan Results for cluster-backup-operator ===

**Found vulnerabilities!** Here's what I discovered:

### 📊 **Vulnerability Summary:**
- **Total CVEs Found:** 10 vulnerabilities
- **Standard Library:** 9 CVEs (from Go go1.23.0)
- **Third-party Dependencies:** 1 CVE ⚠️

### 🥉 **Security Assessment: NEEDS ATTENTION**
Dependencies need security updates.

### 📋 **Detailed CVE Breakdown:**

**🔴 Standard Library CVEs (9):**
- `GO-2025-3751` [🟢 LOW]: Sensitive headers not cleared on cross-origin redirect in net/http
- `GO-2025-3750` [🟢 LOW]: Inconsistent handling of O_CREATE|O_EXCL on Unix and Windows in os
- `GO-2025-3563` [🟢 LOW]: Request smuggling due to acceptance of invalid chunked data in net/http
- `GO-2025-3447` [🟢 LOW]: Timing sidechannel for P-256 on ppc64le in crypto/internal/nistec
- `GO-2025-3420` [🟢 LOW]: Sensitive headers incorrectly sent after cross-domain redirect in net/http
- `GO-2025-3373` [🟢 LOW]: Usage of IPv6 zone IDs can bypass URI name constraints in crypto/x509
- `GO-2024-3107` [🟢 LOW]: Stack exhaustion in Parse in go/build/constraint
- `GO-2024-3106` [🟢 LOW]: Stack exhaustion in Decoder.Decode in encoding/gob
- `GO-2024-3105` [🟢 LOW]: Stack exhaustion in all Parse functions in go/parser

**🟡 Third-party Dependencies (1):**
- `GO-2025-3595` [🟢 LOW]: Incorrect Neutralization of Input During Web Page Generation in x/net
  📦 **Module**: `golang.org/x/net`
  📍 **Found in**: `golang.org/x/net@v0.36.0`

### 🚀 **Recommended Fixes:**

1. **Update Go version:**
```bash
go install golang.org/dl/go1.23.11@latest
go1.23.11 download
go mod edit -go=1.23.11
go mod tidy
```

2. **Update vulnerable dependencies:**
```bash
go get -u golang.org/x/net@latest
```

=== Security Recommendations ===
🔄 Ongoing Security Practices:
  • Weekly scans: ./scripts/vuln-check.sh -m
  • Pre-release: ./scripts/vuln-check.sh -a -v
  • CI Integration: Add vulnerability checks to GitHub Actions

📚 Learn More:
  • Go Security: https://go.dev/security/
  • Vulnerability DB: https://pkg.go.dev/vuln/
```

### Severity Badge Legend

- 🟢 **LOW** - Minor issues, can be scheduled for regular maintenance
- 🟡 **MEDIUM** - Moderate risk, should be addressed in next release cycle  
- 🔴 **HIGH** - Significant risk, requires prompt attention
- 💀 **CRITICAL** - Severe security risk, immediate action required

### Technical Details

### Severity Detection Method

The vulnerability scanner employs a multi-layered approach to determine severity:

1. **Real-time API Fetching** - Queries the Go vulnerability database at `https://pkg.go.dev/vuln/` for each CVE
2. **Intelligent Parsing** - Extracts severity information from vulnerability database responses
3. **Fallback Classification** - Uses pattern matching on vulnerability descriptions when API data is unavailable:
   - Stack exhaustion, DoS patterns → `MEDIUM`
   - Code execution, overflow patterns → `HIGH` 
   - Information disclosure, bypass → `MEDIUM`
   - Unknown patterns → `UNKNOWN`

### Performance Optimizations

- **Concurrent Processing** - Fetches severity data in parallel for faster scanning
- **Timeout Protection** - 3-second timeout per API request to prevent hanging
- **Graceful Degradation** - Continues operation even if vulnerability database is unreachable


### Exit Codes

- `0` - No vulnerabilities found
- `1` - Script error or vulnerabilities found
- `2` - Symbol scan found vulnerabilities
- `3` - Module scan found vulnerabilities

### Common Issues

**govulncheck not found:**
```bash
./scripts/vuln-check.sh -i  # Install the tool
```

**Internal errors:**
- Update Go to latest patch version
- Clear module cache: `go clean -modcache`

**Binary not found:**
- Script will automatically run `make build`
- Ensure project builds successfully first

### Security Workflow

1. **Daily/Weekly**: `./scripts/vuln-check.sh -m`
2. **Pre-release**: `./scripts/vuln-check.sh -a -v`
3. **After Go updates**: `./scripts/vuln-check.sh -s`
4. **CI Pipeline**: `./scripts/vuln-check.sh -m`

### Related Links

- [govulncheck documentation](https://pkg.go.dev/golang.org/x/vuln/cmd/govulncheck)
- [Go vulnerability database](https://pkg.go.dev/vuln/)
- [Security advisories](https://github.com/golang/vulndb) 